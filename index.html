<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Multi-Channel Inquiry • Hostinger DB + Agent Dashboard</title>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 CDN (UMD) + Babel for JSX -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <meta name="color-scheme" content="dark light" />
  </head>

  <body class="min-h-screen bg-slate-950 text-slate-100">
    <div id="root"></div>

    <script type="text/babel">
      const { useEffect, useMemo, useState } = React;

      /********************************************************************
       * ✅ CONFIG (CHANGE THESE 2 VALUES)
       ********************************************************************/
      // Your Hostinger API folder (where you uploaded /api/*.php)
      // Example: https://form-test-for-smallbiz.bhetyhub.com/api
      const API_BASE = "https://form-test-for-smallbiz.bhetyhub.com/api";

      // Must match $API_KEY in Hostinger: public_html/api/_config.php
      const API_KEY = "1kiAi!q6Q|U,,TL0.Rlzw!#U!LUhsYUk";

      /********************************************************************
       * OPTIONAL: LocalStorage key
       ********************************************************************/
      const STORAGE_KEY = "inquiries_local_v1";

      /********************************************************************
       * Helpers
       ********************************************************************/
      function safeParseJSON(s, fallback) {
        try { return JSON.parse(s); } catch { return fallback; }
      }

      function loadLocal() {
        return safeParseJSON(localStorage.getItem(STORAGE_KEY) || "[]", []);
      }

      function saveLocal(items) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
      }

      function nowIso() {
        return new Date().toISOString();
      }

      function normalizeSource(s) {
        const v = (s || "").toLowerCase().trim();
        if (["whatsapp", "wa", "whats", "whatsup", "whats_app"].includes(v)) return "whatsapp";
        if (["viber", "vb"].includes(v)) return "viber";
        if (["facebook", "fb", "messenger"].includes(v)) return "facebook";
        return "facebook";
      }

      function parseQS() {
        const qs = new URLSearchParams(window.location.search);
        const mode = (qs.get("mode") || "form").toLowerCase(); // form | admin
        const source = normalizeSource(qs.get("source") || "facebook");
        return { mode, source };
      }

      function setQS(params) {
        const qs = new URLSearchParams(window.location.search);
        Object.entries(params).forEach(([k, v]) => {
          if (v === null || v === undefined) qs.delete(k);
          else qs.set(k, String(v));
        });
        const newUrl = `${window.location.pathname}?${qs.toString()}`;
        window.history.pushState({}, "", newUrl);
        window.dispatchEvent(new Event("popstate"));
      }

      function digitsOnly(s) {
        return (s || "").replace(/\D/g, "");
      }

      function toWhatsAppNumber(contact) {
        // Basic PH-friendly normalization:
        // 0917xxxxxxx -> 63917xxxxxxx
        // +63... / 63... -> keep digits
        const d = digitsOnly(contact);
        if (!d) return null;
        if (d.startsWith("0")) return "63" + d.slice(1);
        return d;
      }

      function buildCopyText(item) {
        // Real new lines using \n (works when pasting)
        return (
          `New inquiry (${item.source || "unknown"})\n` +
          `Name: ${item.name || "(no name)"}\n` +
          `Contact: ${item.contact || "(no contact)"}\n` +
          `Message:\n${item.message || ""}\n\n` +
          `Reply:\n`
        );
      }

      async function copyToClipboard(text) {
        try {
          await navigator.clipboard.writeText(text);
          return true;
        } catch {
          return false;
        }
      }

      function openChannel(source, contact) {
        const s = normalizeSource(source);

        if (s === "facebook") {
          window.open("https://business.facebook.com/latest/inbox", "_blank", "noopener");
          return;
        }

        if (s === "whatsapp") {
          const wa = toWhatsAppNumber(contact);
          if (!wa) {
            // Open WhatsApp, but not a specific chat
            window.open("https://wa.me/", "_blank", "noopener");
            return;
          }
          window.open(`https://wa.me/${wa}`, "_blank", "noopener");
          return;
        }

        if (s === "viber") {
          const d = digitsOnly(contact);
          if (!d) {
            alert("No phone number found. For Viber we need a phone number in Contact.");
            return;
          }
          // Works best on mobile or when Viber is installed
          window.location.href = `viber://chat?number=%2B${d}`;
          return;
        }

        window.open("https://business.facebook.com/latest/inbox", "_blank", "noopener");
      }

      function SourcePill({ source }) {
        const s = normalizeSource(source);
        const cls =
          s === "facebook"
            ? "bg-indigo-500/15 text-indigo-100 ring-indigo-400/30"
            : s === "whatsapp"
            ? "bg-emerald-500/15 text-emerald-100 ring-emerald-400/30"
            : s === "viber"
            ? "bg-rose-500/15 text-rose-100 ring-rose-400/30"
            : "bg-slate-800/60 text-slate-200 ring-white/10";

        const label =
          s === "facebook" ? "Facebook" : s === "whatsapp" ? "WhatsApp" : s === "viber" ? "Viber" : "Unknown";

        return (
          <span className={`inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ring-1 ${cls}`}>
            {label}
          </span>
        );
      }

      /********************************************************************
       * Hostinger DB API calls
       ********************************************************************/
      async function dbCreate(item) {
        const res = await fetch(`${API_BASE}/inquiry_create.php`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-API-Key": API_KEY,
          },
          body: JSON.stringify(item),
        });

        const json = await res.json().catch(() => ({}));
        if (!res.ok || json.ok === false) throw new Error("DB create failed");
        return true;
      }

      async function dbList(limit = 100) {
        const res = await fetch(`${API_BASE}/inquiry_list.php?limit=${encodeURIComponent(limit)}`, {
          method: "GET",
          headers: { "X-API-Key": API_KEY },
        });

        const json = await res.json().catch(() => ({}));
        if (!res.ok || !json.ok) throw new Error("DB list failed");

        // Normalize createdAt if it comes like "YYYY-MM-DD HH:MM:SS"
        return (json.items || []).map((x) => ({
          ...x,
          source: normalizeSource(x.source),
          createdAt: (x.createdAt || "").includes("T") ? x.createdAt : (x.createdAt ? x.createdAt.replace(" ", "T") : ""),
        }));
      }

      /********************************************************************
       * App
       ********************************************************************/
      function App() {
        const [route, setRoute] = useState(parseQS());

        useEffect(() => {
          const handler = () => setRoute(parseQS());
          window.addEventListener("popstate", handler);
          return () => window.removeEventListener("popstate", handler);
        }, []);

        return (
          <div className="mx-auto max-w-6xl px-4 py-8">
            <Header mode={route.mode} source={route.source} />
            <div className="mt-6 grid gap-5 lg:grid-cols-2">
              <FormCard mode={route.mode} source={route.source} />
              <AdminCard mode={route.mode} />
            </div>
            <Footer />
          </div>
        );
      }

      function Header({ mode, source }) {
        const base = window.location.origin + window.location.pathname;

        return (
          <div className="rounded-3xl border border-white/10 bg-white/[0.04] p-5 shadow-[0_20px_60px_rgba(0,0,0,0.35)] backdrop-blur">
            <div className="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
              <div className="flex items-center gap-3">
                <div className="h-11 w-11 rounded-2xl bg-gradient-to-br from-indigo-500/80 via-emerald-500/60 to-rose-500/60 ring-1 ring-white/15" />
                <div>
                  <div className="text-lg font-extrabold tracking-tight">Inquiry Form + Agent Dashboard</div>
                  <div className="text-xs text-slate-300/80">
                    Hostinger DB + localStorage fallback • Copy → Ctrl+V reply
                  </div>
                </div>
              </div>

              <div className="flex flex-wrap items-center gap-2">
                <span className="rounded-full bg-slate-800/60 px-3 py-1 text-xs font-semibold text-slate-200 ring-1 ring-white/10">
                  Mode: <span className="text-white">{mode}</span>
                </span>
                <span className="rounded-full bg-slate-800/60 px-3 py-1 text-xs font-semibold text-slate-200 ring-1 ring-white/10">
                  Source: <span className="text-white">{source}</span>
                </span>
                <SourcePill source={source} />

                <button
                  className="rounded-2xl border border-white/10 bg-white/[0.06] px-3 py-2 text-sm font-bold text-white hover:bg-white/[0.10]"
                  onClick={() => setQS({ mode: "form" })}
                  type="button"
                >
                  Open Form
                </button>
                <button
                  className="rounded-2xl border border-white/10 bg-white/[0.06] px-3 py-2 text-sm font-bold text-white hover:bg-white/[0.10]"
                  onClick={() => setQS({ mode: "admin" })}
                  type="button"
                >
                  Open Admin
                </button>
              </div>
            </div>

            <div className="mt-4 text-xs text-slate-300/80">
              Share these links in chats (so the inquiry saves the correct source):
              <div className="mt-2 grid gap-1 text-[11px]">
                <div>
                  <span className="font-semibold text-white/90">Facebook:</span>{" "}
                  <code className="rounded bg-black/30 px-1.5 py-0.5">{base}?mode=form&source=facebook</code>
                </div>
                <div>
                  <span className="font-semibold text-white/90">WhatsApp:</span>{" "}
                  <code className="rounded bg-black/30 px-1.5 py-0.5">{base}?mode=form&source=whatsapp</code>
                </div>
                <div>
                  <span className="font-semibold text-white/90">Viber:</span>{" "}
                  <code className="rounded bg-black/30 px-1.5 py-0.5">{base}?mode=form&source=viber</code>
                </div>
              </div>
            </div>

            <div className="mt-4 rounded-2xl border border-white/10 bg-black/20 px-4 py-3 text-xs text-slate-300/80">
              <span className="font-semibold text-white/90">Note:</span> Auto-paste into Messenger/WhatsApp/Viber is not allowed by browsers.
              The agent flow is: <span className="font-semibold text-white/90">Copy + Open</span> → go to chat → <span className="font-semibold text-white/90">Ctrl+V</span> → type reply under <span className="font-semibold text-white/90">Reply:</span>.
            </div>
          </div>
        );
      }

      function FormCard({ mode, source }) {
        const [name, setName] = useState("");
        const [contact, setContact] = useState("");
        const [message, setMessage] = useState("");
        const [status, setStatus] = useState("");
        const [saving, setSaving] = useState(false);

        const visible = mode !== "admin";

        async function submit() {
          const msg = message.trim();
          const contactVal = contact.trim();

          if (!msg) {
            setStatus("Please enter a message.");
            return;
          }

          // Viber needs phone to open chat reliably
          if (normalizeSource(source) === "viber" && !contactVal) {
            setStatus("Phone number is required to reply on Viber.");
            return;
          }

          const item = {
            id: (crypto?.randomUUID ? crypto.randomUUID() : String(Date.now())),
            source: normalizeSource(source),
            name: name.trim() || "(no name)",
            contact: contactVal || "(no contact)",
            message: msg,
            createdAt: nowIso(),
            userAgent: navigator.userAgent,
            pageUrl: window.location.href,
          };

          // ✅ always save locally (fallback)
          const local = loadLocal();
          local.unshift(item);
          saveLocal(local);

          // ✅ try DB save
          setSaving(true);
          try {
            await dbCreate(item);
            setStatus("Inquiry sent! Saved to database.");
          } catch {
            setStatus("Inquiry sent! (Database save failed — saved locally.)");
          } finally {
            setSaving(false);
          }

          setName("");
          setContact("");
          setMessage("");
        }

        function prefill() {
          setName("Jane Doe");
          setContact("09171234567");
          setMessage("Hello! I’d like to ask about pricing and availability.");
          setStatus("");
        }

        return (
          <div className={`rounded-3xl border border-white/10 bg-white/[0.04] p-5 shadow-[0_20px_60px_rgba(0,0,0,0.35)] backdrop-blur ${visible ? "" : "opacity-60"}`}>
            <div className="flex items-start justify-between gap-3">
              <div>
                <h2 className="text-base font-extrabold tracking-tight">Inquiry Form</h2>
                <p className="mt-1 text-sm text-slate-300/80">
                  Customer fills this form. Source comes from the URL <code className="rounded bg-black/30 px-1.5 py-0.5 text-[11px]">source=</code>.
                </p>
              </div>
              <SourcePill source={source} />
            </div>

            <div className="mt-4 grid gap-3">
              <div>
                <label className="text-xs font-bold text-slate-300">Name</label>
                <input
                  className="mt-1 w-full rounded-2xl border border-white/10 bg-black/20 px-4 py-3 text-sm text-white placeholder:text-slate-400 focus:border-indigo-400/50 focus:outline-none"
                  value={name}
                  onChange={(e) => setName(e.target.value)}
                  placeholder="Juan Dela Cruz"
                />
              </div>

              <div>
                <label className="text-xs font-bold text-slate-300">
                  Contact (phone/email)
                  {normalizeSource(source) === "viber" && <span className="ml-2 text-rose-300">(required for Viber)</span>}
                  {normalizeSource(source) === "whatsapp" && <span className="ml-2 text-emerald-200/80">(phone recommended)</span>}
                </label>
                <input
                  className="mt-1 w-full rounded-2xl border border-white/10 bg-black/20 px-4 py-3 text-sm text-white placeholder:text-slate-400 focus:border-indigo-400/50 focus:outline-none"
                  value={contact}
                  onChange={(e) => setContact(e.target.value)}
                  placeholder="0917… or email"
                />
                <div className="mt-1 text-xs text-slate-400">
                  For WhatsApp/Viber “Open chat”, a phone number works best.
                </div>
              </div>

              <div>
                <label className="text-xs font-bold text-slate-300">Message</label>
                <textarea
                  className="mt-1 w-full rounded-2xl border border-white/10 bg-black/20 px-4 py-3 text-sm text-white placeholder:text-slate-400 focus:border-indigo-400/50 focus:outline-none"
                  value={message}
                  onChange={(e) => setMessage(e.target.value)}
                  placeholder="Write your inquiry…"
                />
              </div>

              <div className="flex flex-wrap gap-2 pt-1">
                <button
                  className="rounded-2xl border border-indigo-400/30 bg-indigo-500/20 px-4 py-3 text-sm font-extrabold text-white hover:bg-indigo-500/25 disabled:opacity-60"
                  onClick={submit}
                  disabled={saving}
                  type="button"
                >
                  {saving ? "Sending…" : "Send Inquiry"}
                </button>

                <button
                  className="rounded-2xl border border-white/10 bg-white/[0.06] px-4 py-3 text-sm font-bold text-white hover:bg-white/[0.10]"
                  onClick={prefill}
                  type="button"
                >
                  Prefill Example
                </button>

                <button
                  className="rounded-2xl border border-white/10 bg-white/[0.06] px-4 py-3 text-sm font-bold text-white hover:bg-white/[0.10]"
                  onClick={() => setQS({ mode: "admin" })}
                  type="button"
                >
                  Go to Admin
                </button>
              </div>

              {status ? (
                <div className="rounded-2xl border border-white/10 bg-black/20 px-4 py-3 text-sm text-slate-200">
                  {status}
                </div>
              ) : null}

              <div className="rounded-2xl border border-white/10 bg-black/20 px-4 py-3 text-xs text-slate-300/80">
                This page saves to <span className="font-semibold text-white/90">Hostinger DB</span> and also keeps a{" "}
                <span className="font-semibold text-white/90">localStorage fallback</span>.
              </div>
            </div>
          </div>
        );
      }

      function AdminCard({ mode }) {
        const [items, setItems] = useState([]);
        const [toast, setToast] = useState("");
        const [loading, setLoading] = useState(false);
        const [view, setView] = useState("db"); // db | local

        const visible = mode === "admin";

        async function refreshDb() {
          setLoading(true);
          try {
            const data = await dbList(120);
            setItems(data);
            setView("db");
            setToast("Loaded from database.");
          } catch {
            setToast("Could not load DB. Showing localStorage fallback.");
            setItems(loadLocal());
            setView("local");
          } finally {
            setLoading(false);
            setTimeout(() => setToast(""), 1600);
          }
        }

        function refreshLocal() {
          setItems(loadLocal());
          setView("local");
          setToast("Loaded from localStorage.");
          setTimeout(() => setToast(""), 1600);
        }

        useEffect(() => {
          // On initial mount, try DB first
          refreshDb();
        }, []);

        function clearLocal() {
          localStorage.removeItem(STORAGE_KEY);
          if (view === "local") setItems([]);
          setToast("Cleared localStorage items.");
          setTimeout(() => setToast(""), 1600);
        }

        async function copyOnly(item) {
          const text = buildCopyText(item);
          const ok = await copyToClipboard(text);
          setToast(ok ? "Copied! Paste (Ctrl+V) in chat." : "Copy blocked. Check browser permissions.");
          setTimeout(() => setToast(""), 1800);
          if (!ok) alert(text);
        }

        async function copyAndOpen(item) {
          const text = buildCopyText(item);
          const ok = await copyToClipboard(text);
          openChannel(item.source, item.contact);
          setToast(ok ? "Copied + opened channel. Ctrl+V then reply." : "Opened channel. Copy blocked — use manual copy.");
          setTimeout(() => setToast(""), 2000);
          if (!ok) alert(text);
        }

        return (
          <div className={`rounded-3xl border border-white/10 bg-white/[0.04] p-5 shadow-[0_20px_60px_rgba(0,0,0,0.35)] backdrop-blur ${visible ? "" : "opacity-60"}`}>
            <div className="flex items-start justify-between gap-3">
              <div>
                <h2 className="text-base font-extrabold tracking-tight">Admin Dashboard</h2>
                <p className="mt-1 text-sm text-slate-300/80">
                  Prefer DB view. If DB fails, you can still use localStorage fallback.
                </p>
              </div>

              <div className="flex flex-wrap gap-2">
                <button
                  className="rounded-2xl border border-white/10 bg-white/[0.06] px-3 py-2 text-sm font-bold text-white hover:bg-white/[0.10]"
                  onClick={() => setQS({ mode: "admin" })}
                  type="button"
                >
                  Stay on Admin
                </button>
                <button
                  className="rounded-2xl border border-white/10 bg-white/[0.06] px-3 py-2 text-sm font-bold text-white hover:bg-white/[0.10] disabled:opacity-60"
                  onClick={refreshDb}
                  disabled={loading}
                  type="button"
                >
                  {loading ? "Loading…" : "Refresh DB"}
                </button>
                <button
                  className="rounded-2xl border border-white/10 bg-white/[0.06] px-3 py-2 text-sm font-bold text-white hover:bg-white/[0.10]"
                  onClick={refreshLocal}
                  type="button"
                >
                  View Local
                </button>
                <button
                  className="rounded-2xl border border-rose-400/30 bg-rose-500/15 px-3 py-2 text-sm font-extrabold text-rose-100 hover:bg-rose-500/20"
                  onClick={clearLocal}
                  type="button"
                >
                  Clear Local
                </button>
              </div>
            </div>

            {toast ? (
              <div className="mt-4 rounded-2xl border border-white/10 bg-black/20 px-4 py-3 text-sm text-slate-100">
                {toast}
              </div>
            ) : null}

            <div className="mt-4 flex items-center justify-between">
              <div className="text-xs text-slate-400">
                Viewing:{" "}
                <span className="font-semibold text-white/80">
                  {view === "db" ? "Database (Hostinger)" : "localStorage"}
                </span>
              </div>
              <button
                className="rounded-2xl border border-white/10 bg-white/[0.06] px-3 py-2 text-sm font-bold text-white hover:bg-white/[0.10]"
                onClick={() => setQS({ mode: "form" })}
                type="button"
              >
                Go to Form
              </button>
            </div>

            <div className="mt-4 space-y-3">
              {items.length === 0 ? (
                <div className="rounded-2xl border border-dashed border-white/15 bg-black/10 p-5 text-sm text-slate-300/80">
                  No inquiries yet. Open the Form and submit one.
                </div>
              ) : (
                items.map((item) => (
                  <div key={item.id} className="rounded-3xl border border-white/10 bg-white/[0.06] p-4">
                    <div className="flex flex-wrap items-start justify-between gap-3">
                      <div>
                        <div className="flex items-center gap-2">
                          <div className="text-sm font-extrabold">{item.name}</div>
                          <SourcePill source={item.source} />
                        </div>

                        <div className="mt-1 text-xs text-slate-300/70">
                          <span className="font-semibold text-white/80">Contact:</span> {item.contact}
                        </div>

                        <div className="mt-1 text-xs text-slate-300/70">
                          <span className="font-semibold text-white/80">Received:</span>{" "}
                          {item.createdAt ? new Date(item.createdAt).toLocaleString() : "—"}
                        </div>

                        <div className="mt-1 text-xs text-slate-300/70">
                          <span className="font-semibold text-white/80">ID:</span>{" "}
                          <span className="rounded bg-black/30 px-1.5 py-0.5 font-mono text-[11px]">{item.id}</span>
                        </div>
                      </div>

                      <div className="flex flex-wrap gap-2">
                        <button
                          className="rounded-2xl border border-indigo-400/30 bg-indigo-500/20 px-3 py-2 text-sm font-extrabold text-white hover:bg-indigo-500/25"
                          onClick={() => copyAndOpen(item)}
                          type="button"
                        >
                          Copy + Open
                        </button>

                        <button
                          className="rounded-2xl border border-white/10 bg-white/[0.06] px-3 py-2 text-sm font-bold text-white hover:bg-white/[0.10]"
                          onClick={() => copyOnly(item)}
                          type="button"
                        >
                          Copy Only
                        </button>
                      </div>
                    </div>

                    <div className="mt-3 rounded-2xl border border-white/10 bg-black/20 p-3 text-sm text-slate-100 whitespace-pre-wrap">
                      {item.message}
                    </div>

                    <div className="mt-3 text-xs text-slate-400">
                      Agent: click <span className="font-semibold text-white/80">Copy + Open</span> → go to chat →{" "}
                      <span className="font-semibold text-white/80">Ctrl+V</span> → type reply under{" "}
                      <span className="font-semibold text-white/80">Reply:</span> → send.
                    </div>
                  </div>
                ))
              )}
            </div>
          </div>
        );
      }

      function Footer() {
        return (
          <div className="mt-6 text-center text-xs text-slate-400">
            Hostinger DB endpoints: <span className="font-mono">{API_BASE}</span> • Keep your API key secret.
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
