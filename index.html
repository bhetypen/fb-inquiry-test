<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Multi-Channel Inquiry Dashboard</title>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 CDN (UMD) + Babel for JSX -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <meta name="color-scheme" content="dark light" />
  </head>

  <body class="min-h-screen bg-slate-950 text-slate-100">
    <div id="root"></div>

    <script type="text/babel">
      const { useEffect, useMemo, useState } = React;

      // ===== Config =====
      // Your example Facebook Page ID:
      const FB_PAGE_ID = "61585970293296";

      // LocalStorage key
      const STORAGE_KEY = "inquiry_items_multi_channel_v1";

      // Keep copied message nice and consistent. Ends with Reply: so agent can paste and type underneath.
      function buildCopyText(item) {
        // Use \n for real new lines (works when pasting into Messenger/WhatsApp/Viber)
        return (
          `New inquiry (${item.source || "unknown"})\n` +
          `Name: ${item.name || "(no name)"}\n` +
          `Contact: ${item.contact || "(no contact)"}\n` +
          `Message:\n${item.message || ""}\n\n` +
          `Reply:\n`
        );
      }

      function nowIso() {
        return new Date().toISOString();
      }

      function safeParseJSON(s, fallback) {
        try {
          return JSON.parse(s);
        } catch {
          return fallback;
        }
      }

      function loadItems() {
        return safeParseJSON(localStorage.getItem(STORAGE_KEY) || "[]", []);
      }

      function saveItems(items) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
      }

      function normalizeSource(s) {
  const v = (s || "").toLowerCase().trim();
  if (v === "whatsapp" || v === "wa" || v === "whats" || v === "whatsup" || v === "whats_app") return "whatsapp";
  if (v === "viber" || v === "vb") return "viber";
  if (v === "facebook" || v === "fb" || v === "messenger") return "facebook";
  return "facebook"; // fallback
}

function parseQS() {
  const qs = new URLSearchParams(window.location.search);
  const mode = (qs.get("mode") || "form").toLowerCase();
  const source = normalizeSource(qs.get("source") || "facebook");
  return { mode, source };
}


      function setQS(params) {
        const qs = new URLSearchParams(window.location.search);
        Object.entries(params).forEach(([k, v]) => {
          if (v === null || v === undefined) qs.delete(k);
          else qs.set(k, String(v));
        });
        const newUrl = `${window.location.pathname}?${qs.toString()}`;
        window.history.pushState({}, "", newUrl);
        window.dispatchEvent(new Event("popstate"));
      }

      // Channel openers:
      // - Facebook: open Business Inbox (best for agents)
      // - WhatsApp: open wa.me/<number>
      // - Viber: open viber://chat?number=%2B<digits>
      function digitsOnly(s) {
        return (s || "").replace(/\D/g, "");
      }

      function toWhatsAppNumber(contact) {
        // Basic PH-friendly normalization:
        // - if starts with 0 => replace with 63
        // - if already starts with 63 => ok
        // - else use as-is (works if user enters full intl)
        const d = digitsOnly(contact);
        if (!d) return null;
        if (d.startsWith("0")) return "63" + d.slice(1);
        return d;
      }

      function openChannel(source, contact) {
        if (source === "facebook") {
          // Option A: Business Inbox (recommended)
          window.open("https://business.facebook.com/latest/inbox", "_blank", "noopener");
          return;
        }

        if (source === "whatsapp") {
          const wa = toWhatsAppNumber(contact);
          if (!wa) {
            window.open("https://wa.me/", "_blank", "noopener");
            return;
          }
          window.open(`https://wa.me/${wa}`, "_blank", "noopener");
          return;
        }

        if (source === "viber") {
          const d = digitsOnly(contact);
          // Viber deep link mostly works on mobile (and desktop with Viber installed)
          if (!d) {
            alert("No phone number found for Viber. Please add a number in Contact.");
            return;
          }
          window.location.href = `viber://chat?number=%2B${d}`;
          return;
        }

        // fallback
        window.open("https://business.facebook.com/latest/inbox", "_blank", "noopener");
      }

      async function copyToClipboard(text) {
        try {
          await navigator.clipboard.writeText(text);
          return true;
        } catch {
          return false;
        }
      }

      function Badge({ children, tone = "slate" }) {
        const tones = {
          slate: "bg-slate-800/70 text-slate-200 ring-slate-700/70",
          indigo: "bg-indigo-500/15 text-indigo-200 ring-indigo-400/30",
          emerald: "bg-emerald-500/15 text-emerald-200 ring-emerald-400/30",
          rose: "bg-rose-500/15 text-rose-200 ring-rose-400/30",
          amber: "bg-amber-500/15 text-amber-200 ring-amber-400/30",
        };
        return (
          <span className={`inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ring-1 ${tones[tone] || tones.slate}`}>
            {children}
          </span>
        );
      }

      function SourcePill({ source }) {
        const s = (source || "").toLowerCase();
        if (s === "facebook") return <Badge tone="indigo">Facebook</Badge>;
        if (s === "whatsapp") return <Badge tone="emerald">WhatsApp</Badge>;
        if (s === "viber") return <Badge tone="rose">Viber</Badge>;
        return <Badge tone="slate">{source || "Unknown"}</Badge>;
      }

      function App() {
        const [{ mode, source }, setRoute] = useState(parseQS());

        useEffect(() => {
          const handler = () => setRoute(parseQS());
          window.addEventListener("popstate", handler);
          return () => window.removeEventListener("popstate", handler);
        }, []);

        return (
          <div className="mx-auto max-w-6xl px-4 py-8">
            <Header mode={mode} source={source} />
            <div className="mt-6 grid gap-5 lg:grid-cols-2">
              <FormCard mode={mode} source={source} />
              <AdminCard mode={mode} />
            </div>
            <Footer />
          </div>
        );
      }

      function Header({ mode, source }) {
        return (
          <div className="rounded-3xl border border-white/10 bg-white/[0.04] p-5 shadow-[0_20px_60px_rgba(0,0,0,0.35)] backdrop-blur">
            <div className="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
              <div className="flex items-center gap-3">
                <div className="h-11 w-11 rounded-2xl bg-gradient-to-br from-indigo-500/80 via-emerald-500/60 to-rose-500/60 ring-1 ring-white/15" />
                <div>
                  <div className="text-lg font-extrabold tracking-tight">Inquiry Form + Agent Dashboard</div>
                  <div className="text-xs text-slate-300/80">
                    LocalStorage demo • Copy enquiry → open original channel → Ctrl+V
                  </div>
                </div>
              </div>

              <div className="flex flex-wrap items-center gap-2">
                <span className="rounded-full bg-slate-800/60 px-3 py-1 text-xs font-semibold text-slate-200 ring-1 ring-white/10">
                  Mode: <span className="text-white">{mode}</span>
                </span>

                <span className="rounded-full bg-slate-800/60 px-3 py-1 text-xs font-semibold text-slate-200 ring-1 ring-white/10">
                  Source: <span className="text-white">{source}</span>
                </span>

                <button
                  className="rounded-2xl border border-white/10 bg-white/[0.06] px-3 py-2 text-sm font-bold text-white hover:bg-white/[0.10]"
                  onClick={() => setQS({ mode: "form" })}
                >
                  Open Form
                </button>

                <button
                  className="rounded-2xl border border-white/10 bg-white/[0.06] px-3 py-2 text-sm font-bold text-white hover:bg-white/[0.10]"
                  onClick={() => setQS({ mode: "admin" })}
                >
                  Open Admin
                </button>

                <div className="hidden sm:block">
                  <SourcePill source={source} />
                </div>
              </div>
            </div>

            <div className="mt-4 text-xs text-slate-300/80">
              Share links:
              <span className="ml-2 font-semibold text-white/90">Facebook</span>{" "}
              <code className="rounded bg-black/30 px-1.5 py-0.5 text-[11px]">?mode=form&source=facebook</code>
              <span className="ml-3 font-semibold text-white/90">WhatsApp</span>{" "}
              <code className="rounded bg-black/30 px-1.5 py-0.5 text-[11px]">?mode=form&source=whatsapp</code>
              <span className="ml-3 font-semibold text-white/90">Viber</span>{" "}
              <code className="rounded bg-black/30 px-1.5 py-0.5 text-[11px]">?mode=form&source=viber</code>
            </div>
          </div>
        );
      }

      function FormCard({ mode, source }) {
        const [name, setName] = useState("");
        const [contact, setContact] = useState("");
        const [message, setMessage] = useState("");
        const [status, setStatus] = useState("");

        useEffect(() => {
          setStatus("");
        }, [mode, source]);

        const isVisible = mode !== "admin";

        async function submit() {
  const msg = message.trim();
  if (!msg) {
    setStatus("Please enter a message.");
    return;
  }

  const item = {
    id: (crypto?.randomUUID ? crypto.randomUUID() : String(Date.now())),
    source,
    name: name.trim() || "(no name)",
    contact: contact.trim() || "(no contact)",
    message: msg,
    createdAt: nowIso(),
  };

  // ✅ still save locally
  const items = loadItems();
  items.unshift(item);
  saveItems(items);

  // ✅ send to "simple database" (Google Sheet endpoint)
  try {
    await fetch("https://script.google.com/macros/s/AKfycbywY2NAZBHEzgEmdl8pm53sllpbp2FdYrRyd0H4qimDeaQNTfeTAjl50iW_2vzpej1b/exec", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(item),
    });
    setStatus("Inquiry sent! Saved to database.");
  } catch (err) {
    // still ok because localStorage saved it
    setStatus("Inquiry sent! (Database save failed — still saved locally.)");
  }

  setName("");
  setContact("");
  setMessage("");
}


        

        function prefill() {
          setName("Jane Doe");
          setContact("09171234567");
          setMessage("Hello! I’d like to ask about pricing and availability.");
          setStatus("");
        }

        return (
          <div className={`rounded-3xl border border-white/10 bg-white/[0.04] p-5 shadow-[0_20px_60px_rgba(0,0,0,0.35)] backdrop-blur ${isVisible ? "" : "opacity-60"}`}>
            <div className="flex items-start justify-between gap-3">
              <div>
                <h2 className="text-base font-extrabold tracking-tight">Inquiry Form</h2>
                <p className="mt-1 text-sm text-slate-300/80">
                  Customer fills this form. The <span className="font-semibold text-white/90">source</span> is saved from the URL.
                </p>
              </div>
              <SourcePill source={source} />
            </div>

            <div className="mt-4 grid gap-3">
              <div>
                <label className="text-xs font-bold text-slate-300">Name</label>
                <input
                  className="mt-1 w-full rounded-2xl border border-white/10 bg-black/20 px-4 py-3 text-sm text-white placeholder:text-slate-400 focus:border-indigo-400/50 focus:outline-none"
                  value={name}
                  onChange={(e) => setName(e.target.value)}
                  placeholder="Juan Dela Cruz"
                />
              </div>

              <div>
                <label className="text-xs font-bold text-slate-300">Contact (phone/email)</label>
                <input
                  className="mt-1 w-full rounded-2xl border border-white/10 bg-black/20 px-4 py-3 text-sm text-white placeholder:text-slate-400 focus:border-indigo-400/50 focus:outline-none"
                  value={contact}
                  onChange={(e) => setContact(e.target.value)}
                  placeholder="0917… or email"
                />
                <div className="mt-1 text-xs text-slate-400">
                  Tip: For WhatsApp/Viber open links, a phone number works best.
                </div>
              </div>

              <div>
                <label className="text-xs font-bold text-slate-300">Message</label>
                <textarea
                  className="mt-1 w-full rounded-2xl border border-white/10 bg-black/20 px-4 py-3 text-sm text-white placeholder:text-slate-400 focus:border-indigo-400/50 focus:outline-none"
                  value={message}
                  onChange={(e) => setMessage(e.target.value)}
                  placeholder="Write your inquiry…"
                />
              </div>

              <div className="flex flex-wrap gap-2 pt-1">
                <button
                  className="rounded-2xl border border-indigo-400/30 bg-indigo-500/20 px-4 py-3 text-sm font-extrabold text-white hover:bg-indigo-500/25"
                  onClick={submit}
                >
                  Send Inquiry
                </button>
                <button
                  className="rounded-2xl border border-white/10 bg-white/[0.06] px-4 py-3 text-sm font-bold text-white hover:bg-white/[0.10]"
                  onClick={prefill}
                  type="button"
                >
                  Prefill Example
                </button>
                <button
                  className="rounded-2xl border border-white/10 bg-white/[0.06] px-4 py-3 text-sm font-bold text-white hover:bg-white/[0.10]"
                  onClick={() => setQS({ mode: "admin" })}
                  type="button"
                >
                  Go to Admin
                </button>
              </div>

              {status ? (
                <div className="rounded-2xl border border-white/10 bg-black/20 px-4 py-3 text-sm text-slate-200">
                  {status}
                </div>
              ) : null}

              <div className="rounded-2xl border border-white/10 bg-black/20 px-4 py-3 text-xs text-slate-300/80">
                Share this page in chats with the right source:
                <div className="mt-2 grid gap-1 text-[11px]">
                  <div>
                    <span className="font-semibold text-white/90">Facebook:</span>{" "}
                    <code className="rounded bg-black/30 px-1.5 py-0.5">?mode=form&source=facebook</code>
                  </div>
                  <div>
                    <span className="font-semibold text-white/90">WhatsApp:</span>{" "}
                    <code className="rounded bg-black/30 px-1.5 py-0.5">?mode=form&source=whatsapp</code>
                  </div>
                  <div>
                    <span className="font-semibold text-white/90">Viber:</span>{" "}
                    <code className="rounded bg-black/30 px-1.5 py-0.5">?mode=form&source=viber</code>
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      }

      function AdminCard({ mode }) {
        const [items, setItems] = useState(() => loadItems());
        const [toast, setToast] = useState("");

        useEffect(() => {
          // Refresh list when switching modes or coming back
          const handler = () => setItems(loadItems());
          window.addEventListener("popstate", handler);
          return () => window.removeEventListener("popstate", handler);
        }, []);

        function refresh() {
          setItems(loadItems());
        }

        function clearAll() {
          localStorage.removeItem(STORAGE_KEY);
          setItems([]);
          setToast("Cleared all inquiries.");
          setTimeout(() => setToast(""), 1400);
        }

        function deleteOne(id) {
          const next = loadItems().filter((x) => x.id !== id);
          saveItems(next);
          setItems(next);
        }

        async function copyOnly(item) {
          const text = buildCopyText(item);
          const ok = await copyToClipboard(text);
          setToast(ok ? "Copied! Paste (Ctrl+V) in chat." : "Copy blocked. Check browser permissions.");
          setTimeout(() => setToast(""), 1600);
          if (!ok) alert(text);
        }

        async function copyAndOpen(item) {
          const text = buildCopyText(item);
          const ok = await copyToClipboard(text);
          // Open the channel after copying (agent then Ctrl+V)
          openChannel((item.source || "").toLowerCase(), item.contact);
          setToast(ok ? "Copied + opened channel. Paste (Ctrl+V) then type reply." : "Opened channel. Copy blocked—use manual copy.");
          setTimeout(() => setToast(""), 1800);
          if (!ok) alert(text);
        }

        const isVisible = mode === "admin";

        return (
          <div className={`rounded-3xl border border-white/10 bg-white/[0.04] p-5 shadow-[0_20px_60px_rgba(0,0,0,0.35)] backdrop-blur ${isVisible ? "" : "opacity-60"}`}>
            <div className="flex items-start justify-between gap-3">
              <div>
                <h2 className="text-base font-extrabold tracking-tight">Admin Dashboard</h2>
                <p className="mt-1 text-sm text-slate-300/80">
                  Click <span className="font-semibold text-white/90">Copy + Open</span>, then paste in the original chat and type your reply under <span className="font-semibold text-white/90">Reply:</span>.
                </p>
              </div>

              <div className="flex flex-wrap gap-2">
                <button
                  className="rounded-2xl border border-white/10 bg-white/[0.06] px-3 py-2 text-sm font-bold text-white hover:bg-white/[0.10]"
                  onClick={() => setQS({ mode: "admin" })}
                >
                  Stay on Admin
                </button>
                <button
                  className="rounded-2xl border border-rose-400/30 bg-rose-500/15 px-3 py-2 text-sm font-extrabold text-rose-100 hover:bg-rose-500/20"
                  onClick={clearAll}
                  type="button"
                >
                  Clear All
                </button>
              </div>
            </div>

            {toast ? (
              <div className="mt-4 rounded-2xl border border-white/10 bg-black/20 px-4 py-3 text-sm text-slate-100">
                {toast}
              </div>
            ) : null}

            <div className="mt-4 flex flex-wrap items-center justify-between gap-2">
              <div className="text-xs text-slate-400">
                Stored locally in this browser only (localStorage).
              </div>
              <div className="flex gap-2">
                <button
                  className="rounded-2xl border border-white/10 bg-white/[0.06] px-3 py-2 text-sm font-bold text-white hover:bg-white/[0.10]"
                  onClick={refresh}
                  type="button"
                >
                  Refresh
                </button>
                <button
                  className="rounded-2xl border border-white/10 bg-white/[0.06] px-3 py-2 text-sm font-bold text-white hover:bg-white/[0.10]"
                  onClick={() => setQS({ mode: "form" })}
                  type="button"
                >
                  Go to Form
                </button>
              </div>
            </div>

            <div className="mt-4 space-y-3">
              {items.length === 0 ? (
                <div className="rounded-2xl border border-dashed border-white/15 bg-black/10 p-5 text-sm text-slate-300/80">
                  No inquiries yet. Open the Form and submit one.
                </div>
              ) : (
                items.map((item) => (
                  <div key={item.id} className="rounded-3xl border border-white/10 bg-white/[0.06] p-4">
                    <div className="flex flex-wrap items-start justify-between gap-3">
                      <div>
                        <div className="flex items-center gap-2">
                          <div className="text-sm font-extrabold">{item.name}</div>
                          <SourcePill source={item.source} />
                        </div>
                        <div className="mt-1 text-xs text-slate-300/70">
                          <span className="font-semibold text-white/80">Contact:</span> {item.contact}
                        </div>
                        <div className="mt-1 text-xs text-slate-300/70">
                          <span className="font-semibold text-white/80">Received:</span>{" "}
                          {new Date(item.createdAt).toLocaleString()}
                        </div>
                        <div className="mt-1 text-xs text-slate-300/70">
                          <span className="font-semibold text-white/80">ID:</span>{" "}
                          <span className="rounded bg-black/30 px-1.5 py-0.5 font-mono text-[11px]">{item.id}</span>
                        </div>
                      </div>

                      <div className="flex flex-wrap gap-2">
                        <button
                          className="rounded-2xl border border-indigo-400/30 bg-indigo-500/20 px-3 py-2 text-sm font-extrabold text-white hover:bg-indigo-500/25"
                          onClick={() => copyAndOpen(item)}
                          type="button"
                        >
                          Copy + Open
                        </button>

                        <button
                          className="rounded-2xl border border-white/10 bg-white/[0.06] px-3 py-2 text-sm font-bold text-white hover:bg-white/[0.10]"
                          onClick={() => copyOnly(item)}
                          type="button"
                        >
                          Copy only
                        </button>

                        <button
                          className="rounded-2xl border border-rose-400/30 bg-rose-500/15 px-3 py-2 text-sm font-extrabold text-rose-100 hover:bg-rose-500/20"
                          onClick={() => deleteOne(item.id)}
                          type="button"
                        >
                          Delete
                        </button>
                      </div>
                    </div>

                    <div className="mt-3 rounded-2xl border border-white/10 bg-black/20 p-3 text-sm text-slate-100 whitespace-pre-wrap">
                      {item.message}
                    </div>

                    <div className="mt-3 text-xs text-slate-400">
                      Tip for agents: Click <span className="font-semibold text-white/80">Copy + Open</span>, then in chat press <span className="font-semibold text-white/80">Ctrl+V</span> and type your reply under <span className="font-semibold text-white/80">Reply:</span>.
                    </div>
                  </div>
                ))
              )}
            </div>
          </div>
        );
      }

      function Footer() {
        return (
          <div className="mt-6 text-center text-xs text-slate-400">
            Demo only • Inquiries are saved in localStorage (same device/browser) • For real production use you’ll want a database.
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
